# 애플리케이션 배포 자동화와 CI/CD

## 무중단 배포에 대해

### 리버스 프록시

- 프록시: 클라이언트가 자신을 숨기기 위해 사용하는 것
- 리버스 프록시: 서버가 자신을 숨기기 위해 사용하는 것

### 웹 서버

- 웹 서버: 정적 콘텐츠
- 웹 애플리케이션 서버: 동적 콘텐츠
- 응답 구조: 클라이언트 ↔ 웹 서버 ↔ 웹 애플리케이션 서버
    - 정적 콘텐츠일 경우 웹 서버에서 반환
    - 동적 콘텐츠일 경우 웹 애플리케이션에 응답 요청

### 로드 밸런서

- 요청을 여러 서버로 나누는 역할

### 게이트웨이

- 라우팅, 인증/인가, 로깅, HTTPS, 설정 등을 수행하는 역할

### API 통신에서 발생하는 의존성

- 인프라 구조에 따라 의존성이 발생할 수 있다.
- 서버끼리 의존성이 생기는 것은 좋지 않다. (하나만 문제가 발생해도 모든 기능에 장애 발생 가능)
- 서버 사이에 카프카 등을 사용하는 방법을 사용한다.

## 무중단 배포 테스트하기

### 스트레스 테스트

```yaml
# test-config.yaml

config:
  target: "http://158.247.248.169"
  phases:
    - duration: 100
      arrivalRate: 10
scenarios:
  - flow:
      - get:
        url: "/ui/create-shortenurl.html"

```

```
# terminal

# 1. 부하 테스트
artillery.cmd run test-config.yaml -o report.json

# 2. 리포트 변환
artillery.cmd report report.json -o report.html
```

## CI와 CD에 대해

### CI/CD

- Continuous Integration: 지속적 통합
- Continuous Deployment: 지속적 배포

### 개발 사이클 내에서의 CI/CD

- 여러 개발자가 GitHub에 업로드
    - 메인 브랜치에 푸시/머지하는 과정이 있음
    - 이때 CI Test를 통해 정상적으로 동작하는지 확인해서 머지 여부를 결정
- GitHub의 Webhook/Github Actions를 사용해 Jenkins로 이벤트 전달
- 배포전 CD Test 수행
    - CI Test를 수행하거나 실제 서버에서 정상 동작하는지 확인
    - 인프라적인 문제로 정상 동작하지 않을 수 있는 문제를 확인하는게 대부분
- 정상적으로 테스트가 끝나면 각 서버에 배포

### CI

- 지속적으로 코드가 통합되면서도 정상 동작하는지 검증
- 코드레벨에서 작성된 테스트 코드를 실행
- 많이 사용되는 CI 테스트 실행 시점
    - push에 대해
    - pull request 생성시
    - merge된 후
    - 배포 시작시

### CI/CD와 테스트 코드의 관계

- 테스트 코드를 강제하지 않을 경우 처음엔 편하지만, 기능을 수정하고 배포할 때마다 장애가 발생할 확률이 증가한다.

### CD

- 결과적으로 새로운 코드를 가진 애플리케이션이 성공적으로 서버에서 동작하는지 확인
- 서버에 특정 API를 호출했을 때 200 OK 응답이 와야 배포에 성공하는 것으로 간주하는 E2E Test 방법이 있다.
- 서버에 배포 됐을 때 문제가 되는 경우
    - 인증에 사용하는 token이 만료된 경우
    - 방화벽 문제
    - 네트워크 장애
    - 저장소 장애

### 배포 전략들

- 롤링 배포
    - 하나의 서버씩 배포를 진행
    - 추가적인 리소스 없이 배포 가능
- 블루/그린 배포
    - 새로운 서버에 배포 후 포워딩 수정으로 한번에 배포
    - 상대적으로 어려운 스크립트 작성
    - 추가적인 서버 리소스 필요
- 카나리 배포
    - 새로운 버전을 배포해두고 반응을 본 뒤 점진적으로 배포